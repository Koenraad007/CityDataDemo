@using AP.CityDataDemo.Application.DTOs
@using AP.CityDataDemo.Application.CQRS.Queries.Countries
@using AP.CityDataDemo.Application.CQRS.Commands.Cities
@using AP.CityDataDemo.Application.Exceptions
@using System.ComponentModel.DataAnnotations
@using AP.CityDataDemo.Domain
@using FluentValidation
@using MediatR
@inject IMediator Mediator

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Add New City</h5>
    </div>
    <div class="card-body">
        <EditForm Model="@addCityDto" OnValidSubmit="@HandleValidSubmit" FormName="AddCityForm">
            <DataAnnotationsValidator />
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }
            
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            <div class="mb-3">
                <label for="cityName" class="form-label">City Name</label>
                <InputText id="cityName" class="form-control" @bind-Value="addCityDto.Name" />
                <ValidationMessage For="@(() => addCityDto.Name)" />
            </div>

            <div class="mb-3">
                <label for="population" class="form-label">Population</label>
                <InputNumber id="population" class="form-control" @bind-Value="addCityDto.Population" />
                <ValidationMessage For="@(() => addCityDto.Population)" />
            </div>

            <div class="mb-3">
                <label for="country" class="form-label">Country</label>
                <InputSelect id="country" class="form-select" @bind-Value="addCityDto.CountryId">
                    <option value="0">-- Select a country --</option>
                    @if (countries != null)
                    {
                        @foreach (var country in countries)
                        {
                            <option value="@country.Id">@country.Name</option>
                        }
                    }
                </InputSelect>
                <ValidationMessage For="@(() => addCityDto.CountryId)" />
            </div>

            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Add City</span>
                    }
                </button>
                <button type="button" class="btn btn-secondary" @onclick="ResetForm">Reset</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnCityAdded { get; set; }
    
    private AddCityDto addCityDto = new();
    private IEnumerable<Country>? countries;
    private string? errorMessage;
    private string? successMessage;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            countries = await Mediator.Send(new GetAllCountriesQuery());
        }
        catch (Exception)
        {
            errorMessage = "Could not load countries. Please try again later.";
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            isSubmitting = true;
            errorMessage = null;
            successMessage = null;

            var result = await Mediator.Send(new CreateCityCommand(addCityDto));
            
            successMessage = $"City '{result.Name}' has been successfully added!";
            ResetForm();
            
            await OnCityAdded.InvokeAsync();
        }
        catch (FluentValidation.ValidationException ex)
        {
            // Show the first validation error from FluentValidation
            errorMessage = ex.Errors?.FirstOrDefault()?.ErrorMessage ?? ex.Message;
        }
        catch (ArgumentException ex)
        {
            // Domain guards (e.g. from City constructor)
            errorMessage = ex.Message;
        }
        catch (NotFoundException ex)
        {
            errorMessage = ex.Message;
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while adding the city. Please try again later.";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void ResetForm()
    {
        addCityDto = new AddCityDto();
        errorMessage = null;
        successMessage = null;
    }
}
